{% extends 'base.html' %}

{% block title %}Observations - Vehicle Identity System{% endblock %}
{% block page_title %}All Observations{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h5 class="mb-0">All Observations</h5>
        <p class="text-muted mb-0">Complete history of detected vehicles</p>
    </div>
    <button class="btn btn-primary" onclick="exportCSV()">
        <i class="fas fa-download"></i> Export CSV
    </button>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" class="row g-3">
            <div class="col-md-3">
                <input type="text" class="form-control" name="search" placeholder="Search plate..." 
                       value="{{ search }}">
            </div>
            <div class="col-md-2">
                <select class="form-select" name="source">
                    <option value="all" {% if source_filter == 'all' %}selected{% endif %}>All Sources</option>
                    <option value="image" {% if source_filter == 'image' %}selected{% endif %}>Image</option>
                    <option value="video" {% if source_filter == 'video' %}selected{% endif %}>Video</option>
                    <option value="webcam" {% if source_filter == 'webcam' %}selected{% endif %}>Webcam</option>
                    <option value="ipcam" {% if source_filter == 'ipcam' %}selected{% endif %}>IP Camera</option>
                </select>
            </div>
            <div class="col-md-2">
                <select class="form-select" name="ocr">
                    <option value="all" {% if ocr_filter == 'all' %}selected{% endif %}>All OCR</option>
                    <option value="success" {% if ocr_filter == 'success' %}selected{% endif %}>OCR Success</option>
                    <option value="failed" {% if ocr_filter == 'failed' %}selected{% endif %}>OCR Failed</option>
                </select>
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn btn-primary me-2">
                    <i class="fas fa-search"></i> Filter
                </button>
                <a href="{{ url_for('admin.observations_list') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-times"></i> Clear
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Observations Table -->
<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Timestamp</th>
                        <th>Plate Text</th>
                        <th>Type</th>
                        <th>Color</th>
                        <th>Source</th>
                        <th>OCR</th>
                        <th>Identity</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for obs in observations %}
                    <tr>
                        <td><code>{{ obs.id }}</code></td>
                        <td>{{ obs.timestamp.strftime('%d/%m/%Y %H:%M:%S') if obs.timestamp else '-' }}</td>
                        <td>
                            {% if obs.plate_text %}
                                <strong>{{ obs.plate_text }}</strong>
                            {% else %}
                                <span class="badge badge-ocr-failed">No Plate</span>
                            {% endif %}
                        </td>
                        <td><span class="badge bg-secondary">{{ obs.vehicle_type or 'Unknown' }}</span></td>
                        <td>
                            {% if obs.vehicle_color %}
                                <span class="badge" style="background: {{ obs.vehicle_color }}">{{ obs.vehicle_color }}</span>
                            {% else %}
                                <span class="badge bg-secondary">Unknown</span>
                            {% endif %}
                        </td>
                        <td><span class="badge bg-info">{{ obs.source_type or 'image' }}</span></td>
                        <td>
                            {% if obs.ocr_success %}
                                <span class="badge badge-ocr-success">{{ (obs.plate_confidence * 100)|round|int }}%</span>
                            {% elif obs.ocr_attempted %}
                                <span class="badge badge-ocr-failed">Failed</span>
                            {% else %}
                                <span class="badge bg-secondary">N/A</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{{ url_for('admin.vehicle_detail', id=obs.vehicle_id) }}">
                                <code>#{{ obs.vehicle_id }}</code>
                            </a>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="viewObservation({{ obs.id }})" title="View">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteObservation({{ obs.id }})" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="9" class="text-center text-muted">No observations found</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Pagination -->
{% if pagination.pages > 1 %}
<nav class="mt-4">
    <ul class="pagination justify-content-center">
        {% if pagination.has_prev %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('admin.observations_list', page=pagination.prev_num, search=search, source=source_filter, ocr=ocr_filter) }}">
                    <i class="fas fa-chevron-left"></i>
                </a>
            </li>
        {% endif %}
        
        {% for p in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
            {% if p %}
                <li class="page-item {{ 'active' if p == pagination.page else '' }}">
                    <a class="page-link" href="{{ url_for('admin.observations_list', page=p, search=search, source=source_filter, ocr=ocr_filter) }}">{{ p }}</a>
                </li>
            {% else %}
                <li class="page-item disabled"><span class="page-link">...</span></li>
            {% endif %}
        {% endfor %}
        
        {% if pagination.has_next %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('admin.observations_list', page=pagination.next_num, search=search, source=source_filter, ocr=ocr_filter) }}">
                    <i class="fas fa-chevron-right"></i>
                </a>
            </li>
        {% endif %}
    </ul>
</nav>
<p class="text-center text-muted">
    Showing {{ pagination.page }} of {{ pagination.pages }} pages ({{ pagination.total }} total)
</p>
{% endif %}

<!-- Observation Detail Modal -->
<div class="modal fade" id="observationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Observation Detail</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="observationModalBody">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function viewObservation(id) {
        const modal = new bootstrap.Modal(document.getElementById('observationModal'));
        modal.show();
        
        fetch(`/api/observations/${id}`)
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    const obs = data.data;
                    let html = `
                        <div class="row">
                            <div class="col-md-6">
                                ${obs.annotated_image_path 
                                    ? `<img src="/static/${obs.annotated_image_path.replace('static/', '')}" class="img-fluid rounded mb-3">`
                                    : obs.image_path 
                                        ? `<img src="/static/${obs.image_path.replace('static/', '')}" class="img-fluid rounded mb-3">`
                                        : '<div class="bg-light rounded d-flex align-items-center justify-content-center" style="height: 200px;"><i class="fas fa-image fa-3x text-muted"></i></div>'
                                }
                            </div>
                            <div class="col-md-6">
                                <table class="table table-sm">
                                    <tr><th>ID</th><td>${obs.id}</td></tr>
                                    <tr><th>Timestamp</th><td>${obs.timestamp || '-'}</td></tr>
                                    <tr><th>Plate</th><td>${obs.plate_text || '<span class="badge badge-ocr-failed">N/A</span>'}</td></tr>
                                    <tr><th>OCR Confidence</th><td>${(obs.plate_confidence * 100).toFixed(0)}%</td></tr>
                                    <tr><th>Type</th><td>${obs.vehicle_type || 'Unknown'}</td></tr>
                                    <tr><th>Color</th><td>${obs.vehicle_color || 'Unknown'}</td></tr>
                                    <tr><th>Source</th><td>${obs.source_type || 'image'}</td></tr>
                                    <tr><th>Driver</th><td>${obs.driver_detected ? 'Detected' : 'Not detected'}</td></tr>
                                    <tr><th>Face</th><td>${obs.face_detected ? 'Available' : 'Not available'}</td></tr>
                                </table>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-4">
                                ${obs.plate_image_path 
                                    ? `<img src="/static/${obs.plate_image_path.replace('static/', '')}" class="img-fluid rounded" title="Plate crop">`
                                    : ''
                                }
                            </div>
                            <div class="col-4">
                                ${obs.driver_image_path 
                                    ? `<img src="/static/${obs.driver_image_path.replace('static/', '')}" class="img-fluid rounded" title="Driver crop">`
                                    : ''
                                }
                            </div>
                        </div>
                    `;
                    document.getElementById('observationModalBody').innerHTML = html;
                }
            });
    }
    
    function deleteObservation(id) {
        if (confirm('Are you sure you want to delete this observation?')) {
            fetch(`/api/observations/${id}`, { method: 'DELETE' })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Error: ' + data.error);
                    }
                });
        }
    }
    
    function exportCSV() {
        // Fetch all observations and convert to CSV
        fetch('/api/observations?per_page=10000')
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    const rows = [
                        ['ID', 'Timestamp', 'Plate', 'Confidence', 'Type', 'Color', 'Source', 'Identity ID']
                    ];
                    data.data.forEach(obs => {
                        rows.push([
                            obs.id,
                            obs.timestamp,
                            obs.plate_text || '',
                            obs.plate_confidence,
                            obs.vehicle_type || '',
                            obs.vehicle_color || '',
                            obs.source_type || '',
                            obs.vehicle_id
                        ]);
                    });
                    
                    const csv = rows.map(r => r.join(',')).join('\n');
                    const blob = new Blob([csv], { type: 'text/csv' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `observations_${new Date().toISOString().split('T')[0]}.csv`;
                    a.click();
                }
            });
    }
</script>
{% endblock %}
