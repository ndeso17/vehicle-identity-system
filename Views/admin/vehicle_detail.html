{% extends 'base.html' %} {% block title %}Vehicle #{{ vehicle.id }} - Vehicle
Identity System{% endblock %} {% block page_title %}Vehicle Detail{% endblock %}
{% block content %}
<div class="row">
  <!-- Main Content -->
  <div class="col-md-8">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <a href="{{ url_for('admin.vehicles_list') }}" class="text-muted">
          <i class="fas fa-arrow-left"></i> Back to Vehicles
        </a>
        <h4 class="mt-2 mb-0">
          {% if vehicle.plate_text %} {{ vehicle.plate_text }} {% else %}
          Vehicle #{{ vehicle.id }} {% endif %}
        </h4>
      </div>
      <div>
        {% if vehicle.verified %}
        <span class="badge badge-verified fs-6"
          ><i class="fas fa-check"></i> Verified</span
        >
        {% else %}
        <span class="badge badge-unverified fs-6"
          ><i class="fas fa-clock"></i> Unverified</span
        >
        {% endif %}
      </div>
    </div>

    <!-- Timeline -->
    <div class="card">
      <div
        class="card-header bg-white d-flex justify-content-between align-items-center"
      >
        <h6 class="mb-0">Detection Timeline</h6>
        <span class="badge bg-primary"
          >{{ observations.total }} observations</span
        >
      </div>
      <div class="card-body">
        <div class="timeline">
          {% for obs in observations.items %}
          <div class="timeline-item">
            <div class="card">
              <div class="card-body">
                <div class="row">
                  <div class="col-md-4">
                    {% if obs.annotated_image_path %}
                    <img
                      src="{{ url_for('static', filename=obs.annotated_image_path.replace('static/', '')) }}"
                      class="img-fluid rounded"
                      alt="Annotated"
                      style="cursor: pointer"
                      onclick="showImageModal(this.src)"
                    />
                    {% elif obs.image_path %}
                    <img
                      src="{{ url_for('static', filename=obs.image_path.replace('static/', '')) }}"
                      class="img-fluid rounded"
                      alt="Vehicle"
                      style="cursor: pointer"
                      onclick="showImageModal(this.src)"
                    />
                    {% else %}
                    <div
                      class="bg-light rounded d-flex align-items-center justify-content-center"
                      style="height: 150px"
                    >
                      <i class="fas fa-image fa-3x text-muted"></i>
                    </div>
                    {% endif %}
                  </div>
                  <div class="col-md-8">
                    <h6>
                      {{ obs.timestamp.strftime('%d %b %Y, %H:%M:%S') if
                      obs.timestamp else 'Unknown time' }}
                    </h6>
                    <div class="mb-2">
                      <span class="badge bg-info"
                        >{{ obs.source_type or 'image' }}</span
                      >
                      <span class="badge bg-secondary"
                        >{{ obs.vehicle_type or 'Unknown' }}</span
                      >
                      {% if obs.vehicle_color %}
                      <span
                        class="badge"
                        style="background: {{ obs.vehicle_color }}"
                        >{{ obs.vehicle_color }}</span
                      >
                      {% endif %}
                    </div>

                    <!-- OCR Status -->
                    <div class="mb-2">
                      <strong>OCR:</strong>
                      {% if obs.ocr_success %}
                      <span class="badge badge-ocr-success">
                        {{ obs.plate_text }} ({{ (obs.plate_confidence *
                        100)|round|int }}%)
                      </span>
                      {% elif obs.ocr_attempted %}
                      <span class="badge badge-ocr-failed">Failed</span>
                      {% else %}
                      <span class="badge bg-secondary">Not attempted</span>
                      {% endif %}
                    </div>

                    <!-- Driver Status -->
                    <div class="mb-2">
                      <strong>Driver:</strong>
                      {% if obs.driver_detected %}
                      <span class="badge bg-success">Detected</span>
                      {% if obs.face_detected %}
                      <span class="badge badge-face">Face Available</span>
                      {% endif %} {% else %}
                      <span class="badge bg-secondary">Not detected</span>
                      {% endif %}
                    </div>

                    <!-- Confidence Bar -->
                    <div class="mb-2">
                      <small class="text-muted">OCR Confidence</small>
                      <div class="confidence-bar">
                        <div
                          class="confidence-fill {{ 'high' if obs.plate_confidence >= 0.7 else 'medium' if obs.plate_confidence >= 0.4 else 'low' }}"
                          style="width: {{ (obs.plate_confidence * 100)|round|int }}%"
                        ></div>
                      </div>
                    </div>

                    <!-- View crops -->
                    <div class="btn-group btn-group-sm">
                      {% if obs.plate_image_path %}
                      <button
                        class="btn btn-outline-warning"
                        onclick="showImageModal('{{ url_for('static', filename=obs.plate_image_path.replace('static/', '')) }}')"
                      >
                        <i class="fas fa-id-card"></i> Plate
                      </button>
                      {% endif %} {% if obs.driver_image_path %}
                      <button
                        class="btn btn-outline-danger"
                        onclick="showImageModal('{{ url_for('static', filename=obs.driver_image_path.replace('static/', '')) }}')"
                      >
                        <i class="fas fa-user"></i> Driver
                      </button>
                      {% endif %} {% if obs.frame_image_path %}
                      <button
                        class="btn btn-outline-primary"
                        onclick="showImageModal('{{ url_for('static', filename=obs.frame_image_path.replace('static/', '')) }}')"
                      >
                        <i class="fas fa-expand"></i> Frame
                      </button>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% else %}
          <p class="text-muted text-center">No observations yet</p>
          {% endfor %}
        </div>

        <!-- Pagination -->
        {% if observations.pages > 1 %}
        <nav class="mt-4">
          <ul class="pagination justify-content-center">
            {% if observations.has_prev %}
            <li class="page-item">
              <a class="page-link" href="?page={{ observations.prev_num }}">
                <i class="fas fa-chevron-left"></i>
              </a>
            </li>
            {% endif %} {% for p in observations.iter_pages(left_edge=1,
            right_edge=1, left_current=2, right_current=2) %} {% if p %}
            <li
              class="page-item {{ 'active' if p == observations.page else '' }}"
            >
              <a class="page-link" href="?page={{ p }}">{{ p }}</a>
            </li>
            {% else %}
            <li class="page-item disabled">
              <span class="page-link">...</span>
            </li>
            {% endif %} {% endfor %} {% if observations.has_next %}
            <li class="page-item">
              <a class="page-link" href="?page={{ observations.next_num }}">
                <i class="fas fa-chevron-right"></i>
              </a>
            </li>
            {% endif %}
          </ul>
        </nav>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Sidebar -->
  <div class="col-md-4">
    <!-- Identity Info -->
    <div class="card mb-4">
      <div class="card-header bg-white">
        <h6 class="mb-0">Identity Information</h6>
      </div>
      <div class="card-body">
        <div class="mb-3">
          <small class="text-muted">Identity ID</small>
          <p class="mb-0"><code>{{ vehicle.id }}</code></p>
        </div>
        <div class="mb-3">
          <small class="text-muted">Plate Number</small>
          <p class="mb-0">
            {% if vehicle.plate_text %}
            <strong>{{ vehicle.plate_text }}</strong>
            <span class="badge badge-ocr-success"
              >{{ (vehicle.plate_confidence * 100)|round|int }}%</span
            >
            {% else %}
            <span class="badge badge-ocr-failed">Not Available</span>
            {% endif %}
          </p>
        </div>
        <div class="mb-3">
          <small class="text-muted">Vehicle Type</small>
          <p class="mb-0">
            <span class="badge bg-secondary"
              >{{ vehicle.vehicle_type or 'Unknown' }}</span
            >
          </p>
        </div>
        <div class="mb-3">
          <small class="text-muted">Vehicle Color</small>
          <p class="mb-0">
            {% if vehicle.vehicle_color %}
            <span class="badge" style="background: {{ vehicle.vehicle_color }}"
              >{{ vehicle.vehicle_color }}</span
            >
            {% else %}
            <span class="badge bg-secondary">Unknown</span>
            {% endif %}
          </p>
        </div>
        <div class="mb-3">
          <small class="text-muted">Identity Method</small>
          <p class="mb-0">
            {% if vehicle.identity_method == 'plate' %}
            <span class="badge badge-plate"
              ><i class="fas fa-id-card"></i> Plate OCR (Priority 1)</span
            >
            {% elif vehicle.identity_method == 'face' %}
            <span class="badge badge-face"
              ><i class="fas fa-user"></i> Face Recognition (Priority 2)</span
            >
            {% else %}
            <span class="badge badge-visual"
              ><i class="fas fa-eye"></i> Visual Features (Priority 3)</span
            >
            {% endif %}
          </p>
        </div>
        <div class="mb-3">
          <small class="text-muted">Face Data</small>
          <p class="mb-0">
            {% if vehicle.face_embedding %}
            <span class="badge bg-info">Available</span>
            {% else %}
            <span class="badge bg-secondary">Not Available</span>
            {% endif %}
          </p>
        </div>
        <div class="mb-3">
          <small class="text-muted">First Seen</small>
          <p class="mb-0">
            {{ vehicle.first_seen.strftime('%d %b %Y, %H:%M') if
            vehicle.first_seen else '-' }}
          </p>
        </div>
        <div class="mb-3">
          <small class="text-muted">Last Seen</small>
          <p class="mb-0">
            {{ vehicle.last_seen.strftime('%d %b %Y, %H:%M') if
            vehicle.last_seen else '-' }}
          </p>
        </div>
        <div class="mb-3">
          <small class="text-muted">Total Detections</small>
          <p class="mb-0"><strong>{{ vehicle.detection_count }}</strong></p>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="card mb-4">
      <div class="card-header bg-white">
        <h6 class="mb-0">Actions</h6>
      </div>
      <div class="card-body">
        {% if not vehicle.verified %}
        <button
          class="btn btn-success w-100 mb-2"
          onclick="verifyIdentity({{ vehicle.id }})"
        >
          <i class="fas fa-check"></i> Verify Identity
        </button>
        {% else %}
        <button
          class="btn btn-warning w-100 mb-2"
          onclick="unverifyIdentity({{ vehicle.id }})"
        >
          <i class="fas fa-undo"></i> Unverify Identity
        </button>
        {% endif %}
        <button
          class="btn btn-outline-primary w-100 mb-2"
          onclick="editPlate({{ vehicle.id }}, '{{ vehicle.plate_text or '' }}')"
        >
          <i class="fas fa-edit"></i> Edit Plate
        </button>
        <a
          href="{{ url_for('admin.merge_page') }}?identity={{ vehicle.id }}"
          class="btn btn-outline-info w-100 mb-2"
        >
          <i class="fas fa-code-branch"></i> Merge/Split
        </a>
        <button
          class="btn btn-outline-danger w-100"
          onclick="deleteIdentity({{ vehicle.id }})"
        >
          <i class="fas fa-trash"></i> Delete Identity
        </button>
      </div>
    </div>

    <!-- Merge History -->
    {% if merge_history %}
    <div class="card">
      <div class="card-header bg-white">
        <h6 class="mb-0">History</h6>
      </div>
      <div class="card-body">
        <ul class="list-unstyled small">
          {% for entry in merge_history %}
          <li class="mb-2">
            <span class="badge bg-secondary">{{ entry.action }}</span>
            Identity #{{ entry.identity_id }}
            <br /><small class="text-muted">{{ entry.at }}</small>
          </li>
          {% endfor %}
        </ul>
      </div>
    </div>
    {% endif %}
  </div>
</div>

<!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body text-center p-0">
        <img src="" id="modalImage" class="img-fluid" />
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Close
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  function showImageModal(src) {
      document.getElementById('modalImage').src = src;
      new bootstrap.Modal(document.getElementById('imageModal')).show();
  }

  function verifyIdentity(id) {
      fetch(`/api/identities/${id}/verify`, { method: 'POST' })
          .then(r => r.json())
          .then(data => {
              if (data.success) {
                  location.reload();
              } else {
                  alert('Error: ' + data.error);
              }
          });
  }

  function unverifyIdentity(id) {
      fetch(`/api/identities/${id}/unverify`, { method: 'POST' })
          .then(r => r.json())
          .then(data => {
              if (data.success) {
                  location.reload();
              } else {
                  alert('Error: ' + data.error);
              }
          });
  }

  function editPlate(id, currentPlate) {
      const newPlate = prompt('Enter new plate number:', currentPlate);
      if (newPlate !== null) {
          fetch(`/api/identities/${id}/plate`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ plate_text: newPlate })
          })
          .then(r => r.json())
          .then(data => {
              if (data.success) {
                  location.reload();
              } else {
                  alert('Error: ' + data.error);
              }
          });
      }
  }

  function deleteIdentity(id) {
      if (confirm('Are you sure you want to delete this identity and all its observations?')) {
          fetch(`/api/identities/${id}`, { method: 'DELETE' })
              .then(r => r.json())
              .then(data => {
                  if (data.success) {
                      window.location.href = '{{ url_for('admin.vehicles_list') }}';
                  } else {
                      alert('Error: ' + data.error);
                  }
              });
      }
  }
</script>
{% endblock %}
